{% extends 'base.html' %}
{% load static %}
{% block title %}{{ post.title }} â€” Flavor Blog{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">

  <!-- ===================== ARTICLE HEADER ===================== -->
  <header class="mb-8">
    <div class="flex flex-wrap items-center gap-2 mb-4">
      {% if post.category %}
      <a href="{% url 'post_list' %}?category={{ post.category.slug }}" class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-semibold bg-brand-50 dark:bg-brand-900/30 text-brand-600 dark:text-brand-400 hover:bg-brand-100 transition-colors">
        <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M5.25 2.25a3 3 0 00-3 3v4.318a3 3 0 00.879 2.121l9.58 9.581c.92.92 2.39.986 3.39.162l.009-.008 4.5-4.5.008-.009a2.40 2.40 0 00-.162-3.39l-9.58-9.58a3 3 0 00-2.122-.879H5.25zM6.375 7.5a1.125 1.125 0 100-2.25 1.125 1.125 0 000 2.25z" clip-rule="evenodd"/></svg>
        {{ post.category.name }}
      </a>
      {% endif %}
      {% if post.access_level == 'premium' %}
      <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold bg-amber-50 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400">
        <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.006z" clip-rule="evenodd"/></svg>
        Premium
      </span>
      {% endif %}
      <span class="text-xs text-gray-400 dark:text-gray-500">{{ post.reading_time }} min read</span>
    </div>

    <h1 class="text-3xl sm:text-4xl lg:text-5xl font-extrabold text-gray-900 dark:text-white leading-tight mb-6">{{ post.title }}</h1>

    <!-- Author Bar -->
    <div class="flex items-center justify-between flex-wrap gap-4">
      <div class="flex items-center gap-3">
        <div class="w-11 h-11 rounded-full bg-gradient-to-br from-brand-400 to-purple-500 flex items-center justify-center text-white font-bold text-sm shadow-lg">
          {{ post.author.username|make_list|first|upper }}
        </div>
        <div>
          <p class="font-semibold text-gray-900 dark:text-white text-sm">{{ post.author.username }}</p>
          <p class="text-xs text-gray-500">{{ post.publish_date|date:"F j, Y" }} &middot; {{ post.view_count }} views</p>
        </div>
      </div>

      <!-- Actions -->
      <div class="flex items-center gap-2">
        {% if user.is_authenticated %}
        <!-- Bookmark -->
        <button id="bookmark-btn" class="p-2.5 rounded-xl border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 transition-all {% if is_bookmarked %}text-brand-500{% else %}text-gray-400{% endif %}" title="Save">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M6.32 2.577a49.255 49.255 0 0111.36 0c1.497.174 2.57 1.46 2.57 2.93V21a.75.75 0 01-1.085.67L12 18.089l-7.165 3.583A.75.75 0 013.75 21V5.507c0-1.47 1.073-2.756 2.57-2.93z" clip-rule="evenodd"/></svg>
        </button>
        {% endif %}

        <!-- Share -->
        <button onclick="navigator.clipboard.writeText(window.location.href);this.innerHTML='<svg class=\'w-5 h-5 text-emerald-500\' fill=\'currentColor\' viewBox=\'0 0 24 24\'><path fill-rule=\'evenodd\' d=\'M19.916 4.626a.75.75 0 01.208 1.04l-9 13.5a.75.75 0 01-1.154.114l-6-6a.75.75 0 011.06-1.06l5.353 5.353 8.493-12.739a.75.75 0 011.04-.208z\' clip-rule=\'evenodd\'/></svg>'" class="p-2.5 rounded-xl border border-gray-200 dark:border-gray-700 text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800 transition-all" title="Copy link">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M15.75 4.5a3 3 0 11.825 2.066l-8.421 4.679a3.002 3.002 0 010 1.51l8.421 4.679a3 3 0 11-.729 1.31l-8.421-4.678a3 3 0 110-4.132l8.421-4.679a3 3 0 01-.096-.755z" clip-rule="evenodd"/></svg>
        </button>

        {% if user == post.author %}
        <a href="{% url 'post_update' post.slug %}" class="p-2.5 rounded-xl border border-gray-200 dark:border-gray-700 text-gray-400 hover:text-brand-500 hover:bg-gray-50 dark:hover:bg-gray-800 transition-all" title="Edit">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M21.731 2.269a2.625 2.625 0 00-3.712 0l-1.157 1.157 3.712 3.712 1.157-1.157a2.625 2.625 0 000-3.712zM19.513 8.199l-3.712-3.712-12.15 12.15a5.25 5.25 0 00-1.32 2.214l-.8 2.685a.75.75 0 00.933.933l2.685-.8a5.25 5.25 0 002.214-1.32L19.513 8.2z"/></svg>
        </a>
        <a href="{% url 'post_delete' post.slug %}" class="p-2.5 rounded-xl border border-gray-200 dark:border-gray-700 text-gray-400 hover:text-red-500 hover:bg-gray-50 dark:hover:bg-gray-800 transition-all" title="Delete">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M16.5 4.478v.227a48.816 48.816 0 013.878.512.75.75 0 11-.256 1.478l-.209-.035-1.005 13.07a3 3 0 01-2.991 2.77H8.084a3 3 0 01-2.991-2.77L4.087 6.66l-.209.035a.75.75 0 01-.256-1.478A48.567 48.567 0 017.5 4.705v-.227c0-1.564 1.213-2.9 2.816-2.951a52.662 52.662 0 013.369 0c1.603.051 2.815 1.387 2.815 2.951zm-6.136-1.452a51.196 51.196 0 013.273 0C14.39 3.05 15 3.684 15 4.478v.113a49.488 49.488 0 00-6 0v-.113c0-.794.609-1.428 1.364-1.452zm-.355 5.945a.75.75 0 10-1.5.058l.347 9a.75.75 0 101.499-.058l-.346-9zm5.48.058a.75.75 0 10-1.498-.058l-.347 9a.75.75 0 001.5.058l.345-9z" clip-rule="evenodd"/></svg>
        </a>
        {% endif %}
      </div>
    </div>
  </header>

  <!-- ===================== FEATURED IMAGE ===================== -->
  {% if post.featured_image %}
  <div class="mb-8 rounded-2xl overflow-hidden">
    <img src="{{ post.featured_image.url }}" alt="{{ post.title }}" class="w-full h-auto max-h-[500px] object-cover">
  </div>
  {% endif %}

  <!-- ===================== ARTICLE BODY ===================== -->
  <article class="bg-white dark:bg-gray-900 rounded-2xl border border-gray-100 dark:border-gray-800 p-6 sm:p-10 mb-8">
    {% if paywall %}
      <div class="prose dark:prose-invert max-w-none text-gray-700 dark:text-gray-300 leading-relaxed">
        {{ preview|safe }}
      </div>
      <!-- Paywall CTA -->
      <div class="relative mt-8">
        <div class="absolute inset-x-0 -top-24 h-24 bg-gradient-to-t from-white dark:from-gray-900 to-transparent"></div>
        <div class="text-center p-8 border-2 border-dashed border-brand-200 dark:border-brand-800 rounded-2xl bg-brand-50/50 dark:bg-brand-900/20">
          <div class="w-14 h-14 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-brand-500 to-purple-500 flex items-center justify-center">
            <svg class="w-7 h-7 text-white" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M12 1.5a5.25 5.25 0 00-5.25 5.25v3a3 3 0 00-3 3v6.75a3 3 0 003 3h10.5a3 3 0 003-3v-6.75a3 3 0 00-3-3v-3c0-2.9-2.35-5.25-5.25-5.25zm3.75 8.25v-3a3.75 3.75 0 10-7.5 0v3h7.5z" clip-rule="evenodd"/></svg>
          </div>
          <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">Premium Content</h3>
          <p class="text-gray-500 dark:text-gray-400 mb-6 max-w-md mx-auto">Subscribe to unlock this article and get access to all premium content.</p>
          <a href="{% url 'subscribe' %}" class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-brand-500 to-purple-600 text-white font-semibold rounded-xl hover:from-brand-600 hover:to-purple-700 shadow-lg shadow-brand-500/25 transition-all">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.006z" clip-rule="evenodd"/></svg>
            Upgrade to Premium
          </a>
        </div>
      </div>
    {% else %}
      <div class="prose dark:prose-invert max-w-none text-gray-700 dark:text-gray-300 leading-relaxed text-[17px]">
        {{ post.body|safe }}
      </div>
    {% endif %}

    <!-- Tags -->
    {% if post.tags.all %}
    <div class="flex flex-wrap gap-2 mt-8 pt-6 border-t border-gray-100 dark:border-gray-800">
      {% for tag in post.tags.all %}
      <a href="{% url 'post_list' %}?tag={{ tag.name }}" class="inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 hover:bg-brand-50 dark:hover:bg-brand-900/20 hover:text-brand-600 dark:hover:text-brand-400 transition-all">
        #{{ tag.name }}
      </a>
      {% endfor %}
    </div>
    {% endif %}
  </article>

  <!-- ===================== LIKE & INTERACTION BAR ===================== -->
  <div class="flex items-center justify-between bg-white dark:bg-gray-900 rounded-2xl border border-gray-100 dark:border-gray-800 p-4 mb-8">
    <div class="flex items-center gap-4">
      {% if user.is_authenticated %}
      <button id="like-btn" class="flex items-center gap-2 px-4 py-2.5 rounded-xl font-medium text-sm transition-all
        {% if is_liked %}bg-red-50 dark:bg-red-900/20 text-red-500{% else %}bg-gray-100 dark:bg-gray-800 text-gray-500 hover:bg-red-50 dark:hover:bg-red-900/20 hover:text-red-500{% endif %}">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007.004-.003.001a.752.752 0 01-.704 0l-.003-.001z"/></svg>
        <span id="like-count">{{ like_count }}</span>
      </button>
      {% else %}
      <a href="{% url 'login' %}?next={{ request.path }}" class="flex items-center gap-2 px-4 py-2.5 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-500 text-sm font-medium hover:bg-red-50 hover:text-red-500 transition-all">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007.004-.003.001a.752.752 0 01-.704 0l-.003-.001z"/></svg>
        <span>{{ like_count }}</span>
      </a>
      {% endif %}

      <span class="flex items-center gap-2 text-sm text-gray-400">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M4.848 2.771A49.144 49.144 0 0112 2.25c2.43 0 4.817.178 7.152.52 1.978.292 3.348 2.024 3.348 3.97v6.02c0 1.946-1.37 3.678-3.348 3.97a48.901 48.901 0 01-3.476.383.39.39 0 00-.297.17l-2.755 4.133a.75.75 0 01-1.248 0l-2.755-4.133a.39.39 0 00-.297-.17 48.9 48.9 0 01-3.476-.384c-1.978-.29-3.348-2.024-3.348-3.97V6.741c0-1.946 1.37-3.68 3.348-3.97z" clip-rule="evenodd"/></svg>
        {{ comments.count }} comment{{ comments.count|pluralize }}
      </span>
    </div>

    <span class="flex items-center gap-1.5 text-sm text-gray-400">
      <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 15a3 3 0 100-6 3 3 0 000 6z"/><path fill-rule="evenodd" d="M1.323 11.447C2.811 6.976 7.028 3.75 12.001 3.75c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113-1.487 4.471-5.705 7.697-10.677 7.697-4.97 0-9.186-3.223-10.675-7.69a1.762 1.762 0 010-1.113zM17.25 12a5.25 5.25 0 11-10.5 0 5.25 5.25 0 0110.5 0z" clip-rule="evenodd"/></svg>
      {{ post.view_count }} views
    </span>
  </div>

  <!-- ===================== COMMENTS ===================== -->
  <section class="bg-white dark:bg-gray-900 rounded-2xl border border-gray-100 dark:border-gray-800 p-6 sm:p-8 mb-8">
    <h2 class="flex items-center gap-2 text-xl font-bold text-gray-900 dark:text-white mb-6">
      <svg class="w-5 h-5 text-brand-500" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M4.848 2.771A49.144 49.144 0 0112 2.25c2.43 0 4.817.178 7.152.52 1.978.292 3.348 2.024 3.348 3.97v6.02c0 1.946-1.37 3.678-3.348 3.97a48.901 48.901 0 01-3.476.383.39.39 0 00-.297.17l-2.755 4.133a.75.75 0 01-1.248 0l-2.755-4.133a.39.39 0 00-.297-.17 48.9 48.9 0 01-3.476-.384c-1.978-.29-3.348-2.024-3.348-3.97V6.741c0-1.946 1.37-3.68 3.348-3.97z" clip-rule="evenodd"/></svg>
      Discussion ({{ comments.count }})
    </h2>

    <!-- Comment Form -->
    {% if user.is_authenticated %}
    <form method="post" action="{% url 'add_comment' post.slug %}" class="mb-8">
      {% csrf_token %}
      <div class="flex gap-3">
        <div class="flex-shrink-0 w-9 h-9 rounded-full bg-gradient-to-br from-brand-400 to-purple-500 flex items-center justify-center text-white text-xs font-bold mt-1">
          {{ user.username|make_list|first|upper }}
        </div>
        <div class="flex-1">
          {{ comment_form.body }}
          <div class="mt-3 flex justify-end">
            <button type="submit" class="inline-flex items-center gap-2 px-5 py-2.5 bg-brand-500 text-white font-semibold rounded-xl hover:bg-brand-600 transition-all text-sm shadow-lg shadow-brand-500/25">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z"/></svg>
              Post Comment
            </button>
          </div>
        </div>
      </div>
    </form>
    {% else %}
    <div class="mb-8 p-4 bg-gray-50 dark:bg-gray-800 rounded-xl text-center">
      <p class="text-sm text-gray-500">
        <a href="{% url 'login' %}?next={{ request.path }}" class="text-brand-600 dark:text-brand-400 font-semibold hover:underline">Sign in</a> to join the conversation.
      </p>
    </div>
    {% endif %}

    <!-- Comments List -->
    <div id="comment-list" class="space-y-4">
      {% for comment in comments %}
      <div class="flex gap-3 p-4 rounded-xl bg-gray-50 dark:bg-gray-800/50 transition-all hover:bg-gray-100 dark:hover:bg-gray-800">
        <div class="flex-shrink-0 w-9 h-9 rounded-full bg-gradient-to-br from-emerald-400 to-teal-500 flex items-center justify-center text-white text-xs font-bold">
          {{ comment.author.username|make_list|first|upper }}
        </div>
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2 mb-1">
            <span class="font-semibold text-sm text-gray-900 dark:text-white">{{ comment.author.username }}</span>
            <span class="text-xs text-gray-400">{{ comment.created_date|timesince }} ago</span>
          </div>
          <div class="text-sm text-gray-600 dark:text-gray-300 leading-relaxed">{{ comment.body|linebreaks }}</div>
        </div>
      </div>
      {% empty %}
      <div id="no-comments-msg" class="text-center py-8">
        <svg class="w-12 h-12 mx-auto mb-3 text-gray-200 dark:text-gray-700" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M4.848 2.771A49.144 49.144 0 0112 2.25c2.43 0 4.817.178 7.152.52 1.978.292 3.348 2.024 3.348 3.97v6.02c0 1.946-1.37 3.678-3.348 3.97a48.901 48.901 0 01-3.476.383.39.39 0 00-.297.17l-2.755 4.133a.75.75 0 01-1.248 0l-2.755-4.133a.39.39 0 00-.297-.17 48.9 48.9 0 01-3.476-.384c-1.978-.29-3.348-2.024-3.348-3.97V6.741c0-1.946 1.37-3.68 3.348-3.97z" clip-rule="evenodd"/></svg>
        <p class="text-gray-400 font-medium">No comments yet</p>
        <p class="text-sm text-gray-300 dark:text-gray-600 mt-1">Be the first to share your thoughts!</p>
      </div>
      {% endfor %}
    </div>
  </section>

  <!-- ===================== RELATED POSTS ===================== -->
  {% if related_posts %}
  <section class="mb-8">
    <h2 class="flex items-center gap-2 text-xl font-bold text-gray-900 dark:text-white mb-6">
      <svg class="w-5 h-5 text-brand-500" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M15.22 6.268a.75.75 0 01.968-.431l5.942 2.28a.75.75 0 01.431.97l-2.28 5.941a.75.75 0 11-1.4-.537l1.63-4.251-1.086.483a11.2 11.2 0 00-5.45 5.174.75.75 0 01-1.199.19L9 12.31l-6.22 6.22a.75.75 0 11-1.06-1.06l6.75-6.75a.75.75 0 011.06 0l3.606 3.605a12.694 12.694 0 015.68-4.973l1.086-.484-4.251-1.631a.75.75 0 01-.432-.97z" clip-rule="evenodd"/></svg>
      More like this
    </h2>
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
      {% for rp in related_posts %}
      <a href="{{ rp.get_absolute_url }}" class="card-hover group block bg-white dark:bg-gray-900 rounded-2xl border border-gray-100 dark:border-gray-800 p-5">
        <h3 class="font-bold text-gray-900 dark:text-white group-hover:text-brand-500 transition-colors mb-2 leading-snug">{{ rp.title }}</h3>
        <p class="text-xs text-gray-400">{{ rp.publish_date|date:"M d, Y" }} &middot; {{ rp.reading_time }} min read</p>
      </a>
      {% endfor %}
    </div>
  </section>
  {% endif %}

</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;

    // --- AJAX Like ---
    const likeBtn = document.getElementById('like-btn');
    if (likeBtn) {
        likeBtn.addEventListener('click', function(e) {
            e.preventDefault();
            fetch("{% url 'like_post' post.slug %}", {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken, 'Content-Type': 'application/json' }
            })
            .then(r => r.json())
            .then(data => {
                document.getElementById('like-count').textContent = data.count;
                if (data.liked) {
                    likeBtn.classList.add('bg-red-50', 'dark:bg-red-900/20', 'text-red-500');
                    likeBtn.classList.remove('bg-gray-100', 'dark:bg-gray-800', 'text-gray-500');
                } else {
                    likeBtn.classList.remove('bg-red-50', 'dark:bg-red-900/20', 'text-red-500');
                    likeBtn.classList.add('bg-gray-100', 'dark:bg-gray-800', 'text-gray-500');
                }
            })
            .catch(err => console.error(err));
        });
    }

    // --- AJAX Bookmark ---
    const bookmarkBtn = document.getElementById('bookmark-btn');
    if (bookmarkBtn) {
        bookmarkBtn.addEventListener('click', function(e) {
            e.preventDefault();
            fetch("{% url 'toggle_bookmark' post.slug %}", {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken, 'Content-Type': 'application/json' }
            })
            .then(r => r.json())
            .then(data => {
                if (data.bookmarked) {
                    bookmarkBtn.classList.add('text-brand-500');
                    bookmarkBtn.classList.remove('text-gray-400');
                } else {
                    bookmarkBtn.classList.remove('text-brand-500');
                    bookmarkBtn.classList.add('text-gray-400');
                }
            })
            .catch(err => console.error(err));
        });
    }

    // --- WebSocket for Live Comments ---
    try {
        const postSlug = '{{ post.slug }}';
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const commentSocket = new WebSocket(protocol + '//' + window.location.host + '/ws/comments/' + postSlug + '/');

        commentSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const comment = data.comment;
            const commentList = document.getElementById('comment-list');
            const noMsg = document.getElementById('no-comments-msg');
            if (noMsg) noMsg.remove();

            const div = document.createElement('div');
            div.className = 'flex gap-3 p-4 rounded-xl bg-gray-50 dark:bg-gray-800/50 opacity-0 transition-all duration-500';
            div.innerHTML = `
                <div class="flex-shrink-0 w-9 h-9 rounded-full bg-gradient-to-br from-emerald-400 to-teal-500 flex items-center justify-center text-white text-xs font-bold">${comment.author[0].toUpperCase()}</div>
                <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="font-semibold text-sm text-gray-900 dark:text-white">${comment.author}</span>
                        <span class="text-xs text-gray-400">Just now</span>
                    </div>
                    <div class="text-sm text-gray-600 dark:text-gray-300">${comment.body.replace(/\n/g, '<br>')}</div>
                </div>
            `;
            commentList.prepend(div);
            setTimeout(() => div.style.opacity = 1, 50);
        };
        commentSocket.onclose = function() { console.warn('Comment socket closed'); };
    } catch(e) {}
});
</script>
{% endblock %}